# =============================================================================
# Docker Compose - Local Development (Infrastructure Only)
# =============================================================================
# Solo servicios de infraestructura. El servidor web corre localmente
# para mejor performance (sin virtualizaci√≥n).
#
# Puertos fijos terminados en 43 para evitar conflictos:
#   - PostgreSQL: 5443
#   - Redis: 6343
#   - MinIO API: 9043
#   - MinIO Console: 9143
#   - RQ Dashboard: 9243
#
# Uso:
#   docker compose -f docker-compose.local.yml up -d
#   uvicorn app.main:app --reload --port 8043  # Servidor web local
# =============================================================================

services:
  postgres:
    container_name: school-attendance-postgres-local
    image: postgres:15
    environment:
      POSTGRES_USER: school_attendance
      POSTGRES_PASSWORD: school_attendance
      POSTGRES_DB: school_attendance
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U school_attendance -d school_attendance"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data_local:/var/lib/postgresql/data
    ports:
      - "5443:5432"

  redis:
    container_name: school-attendance-redis-local
    image: redis:7
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    ports:
      - "6343:6379"

  minio:
    container_name: school-attendance-minio-local
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: dev-access
      MINIO_ROOT_PASSWORD: dev-secret
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - minio_data_local:/data
    ports:
      - "9043:9000"
      - "9143:9001"

  # Background worker for RQ jobs
  worker:
    container_name: school-attendance-worker-local
    build:
      context: .
      dockerfile: Dockerfile
    command: python -m app.workers.rq_worker
    environment:
      APP_ENV: development
      DATABASE_URL: postgresql+asyncpg://school_attendance:school_attendance@host.docker.internal:5443/school_attendance
      REDIS_URL: redis://host.docker.internal:6343/0
      SECRET_KEY: local-dev-secret-key
      S3_ENDPOINT: http://host.docker.internal:9043
      S3_BUCKET: attendance-photos
      S3_ACCESS_KEY: dev-access
      S3_SECRET_KEY: dev-secret
      S3_REGION: us-east-1
      S3_SECURE: "false"
      # Web Push VAPID keys (needed for sending push notifications)
      VAPID_PUBLIC_KEY: BG20KqGfbFlLuZQPdz1ya3ZJEwJ8wO1UWC_O4hcdHM5gw5dQ-1zM5qKOOsTn40906Zs2UVD2ax0wCh21d9I0krM
      VAPID_PRIVATE_KEY: 0DrMeX3Wadu9eEAGH8YgC-l9nIZg0qj6QRe4-dI9nMI
      VAPID_SUBJECT: mailto:admin@school.cl
      ENABLE_REAL_NOTIFICATIONS: "false"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./app:/app/app:ro

  # Scheduler for periodic jobs
  scheduler:
    container_name: school-attendance-scheduler-local
    build:
      context: .
      dockerfile: Dockerfile
    command: python -m app.workers.scheduler
    environment:
      APP_ENV: development
      DATABASE_URL: postgresql+asyncpg://school_attendance:school_attendance@host.docker.internal:5443/school_attendance
      REDIS_URL: redis://host.docker.internal:6343/0
      SECRET_KEY: local-dev-secret-key
      S3_ENDPOINT: http://host.docker.internal:9043
      S3_BUCKET: attendance-photos
      S3_ACCESS_KEY: dev-access
      S3_SECRET_KEY: dev-secret
      S3_REGION: us-east-1
      S3_SECURE: "false"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./app:/app/app:ro

  # RQ Dashboard
  rq-dashboard:
    container_name: school-attendance-rq-dashboard-local
    image: eoranged/rq-dashboard
    environment:
      RQ_DASHBOARD_REDIS_URL: redis://host.docker.internal:6343/0
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "9243:9181"

volumes:
  postgres_data_local:
  minio_data_local:
