services:
  postgres:
    container_name: ${APP_NAME:-school-attendance}-postgres-${APP_ENV:-dev}
    image: postgres:15
    # Password sync: PostgreSQL ignores POSTGRES_PASSWORD on existing volumes.
    # This entrypoint syncs the password before starting postgres.
    # See docs/postgres-password-sync.md for details.
    entrypoint:
      - bash
      - -c
      - |
        set -e
        PGDATA="$${PGDATA:-/var/lib/postgresql/data}"
        if [ -f "$$PGDATA/PG_VERSION" ]; then
          echo "==> [password-sync] Detected existing data directory"
          echo "==> [password-sync] Synchronizing password with POSTGRES_PASSWORD..."
          gosu postgres pg_ctl -D "$$PGDATA" -o "-c listen_addresses=''" -w start
          gosu postgres psql -U "$$POSTGRES_USER" -d "$${POSTGRES_DB:-$$POSTGRES_USER}" -c \
            "ALTER USER \"$$POSTGRES_USER\" WITH PASSWORD '$$POSTGRES_PASSWORD';" \
            > /dev/null 2>&1
          gosu postgres pg_ctl -D "$$PGDATA" -m fast -w stop
          echo "==> [password-sync] Password synchronized successfully"
        else
          echo "==> [password-sync] Fresh volume detected, skipping password sync"
        fi
        exec docker-entrypoint.sh "$$@"
      - --
    command: ["postgres"]
    environment:
      POSTGRES_USER: ${DB_USER:-school_attendance}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-school_attendance}
      POSTGRES_DB: ${DB_NAME:-school_attendance}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-school_attendance} -d ${DB_NAME:-school_attendance}"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app_net

  redis:
    container_name: ${APP_NAME:-school-attendance}-redis-${APP_ENV:-dev}
    image: redis:7
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - app_net

  minio:
    container_name: ${APP_NAME:-school-attendance}-minio-${APP_ENV:-dev}
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-dev-access}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-dev-secret}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - minio_data:/data
    networks:
      - app_net

  # Main API + Frontend monolith
  school-attendance:
    container_name: ${APP_NAME:-school-attendance}-${APP_ENV:-dev}
    image: ${REGISTRY_USER:-moffermann}/school-attendance:${IMAGE_TAG:-latest}
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: postgresql+asyncpg://${DB_USER:-school_attendance}:${DB_PASSWORD:-school_attendance}@${APP_NAME:-school-attendance}-postgres-${APP_ENV:-dev}:5432/${DB_NAME:-school_attendance}
      REDIS_URL: redis://${APP_NAME:-school-attendance}-redis-${APP_ENV:-dev}:6379/0
      S3_ENDPOINT: http://${APP_NAME:-school-attendance}-minio-${APP_ENV:-dev}:9000
      S3_BUCKET: ${S3_BUCKET:-attendance-photos}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-dev-access}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-dev-secret}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_SECURE: "false"
      SECRET_KEY: ${SECRET_KEY:-CHANGE-ME-IN-PRODUCTION}
      DEVICE_API_KEY: ${DEVICE_API_KEY:-CHANGE-ME-IN-PRODUCTION}
      SES_SOURCE_EMAIL: ${SES_SOURCE_EMAIL:-no-reply@example.com}
      WHATSAPP_ACCESS_TOKEN: ${WHATSAPP_ACCESS_TOKEN:-dummy}
      WHATSAPP_PHONE_NUMBER_ID: ${WHATSAPP_PHONE_NUMBER_ID:-dummy}
      CORS_ORIGINS: ${CORS_ORIGINS:-[]}
      RATE_LIMIT_DEFAULT: ${RATE_LIMIT_DEFAULT:-100/minute}
      # WebAuthn / Biometric Authentication
      WEBAUTHN_RP_ID: ${WEBAUTHN_RP_ID:-localhost}
      WEBAUTHN_RP_NAME: ${WEBAUTHN_RP_NAME:-Sistema Asistencia Escolar}
      WEBAUTHN_RP_ORIGIN: ${WEBAUTHN_RP_ORIGIN:-http://localhost:8080}
      WEBAUTHN_TIMEOUT_MS: ${WEBAUTHN_TIMEOUT_MS:-60000}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/healthz"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - app_net

  # Background worker for RQ jobs
  worker:
    container_name: ${APP_NAME:-school-attendance}-worker-${APP_ENV:-dev}
    image: ${REGISTRY_USER:-moffermann}/school-attendance:${IMAGE_TAG:-latest}
    command: python -m app.workers.rq_worker
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: postgresql+asyncpg://${DB_USER:-school_attendance}:${DB_PASSWORD:-school_attendance}@${APP_NAME:-school-attendance}-postgres-${APP_ENV:-dev}:5432/${DB_NAME:-school_attendance}
      REDIS_URL: redis://${APP_NAME:-school-attendance}-redis-${APP_ENV:-dev}:6379/0
      SECRET_KEY: ${SECRET_KEY:-CHANGE-ME-IN-PRODUCTION}
      S3_ENDPOINT: http://${APP_NAME:-school-attendance}-minio-${APP_ENV:-dev}:9000
      S3_BUCKET: ${S3_BUCKET:-attendance-photos}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-dev-access}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-dev-secret}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_SECURE: "false"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app_net

  # Scheduler for periodic jobs
  scheduler:
    container_name: ${APP_NAME:-school-attendance}-scheduler-${APP_ENV:-dev}
    image: ${REGISTRY_USER:-moffermann}/school-attendance:${IMAGE_TAG:-latest}
    command: python -m app.workers.scheduler
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: postgresql+asyncpg://${DB_USER:-school_attendance}:${DB_PASSWORD:-school_attendance}@${APP_NAME:-school-attendance}-postgres-${APP_ENV:-dev}:5432/${DB_NAME:-school_attendance}
      REDIS_URL: redis://${APP_NAME:-school-attendance}-redis-${APP_ENV:-dev}:6379/0
      SECRET_KEY: ${SECRET_KEY:-CHANGE-ME-IN-PRODUCTION}
      S3_ENDPOINT: http://${APP_NAME:-school-attendance}-minio-${APP_ENV:-dev}:9000
      S3_BUCKET: ${S3_BUCKET:-attendance-photos}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-dev-access}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-dev-secret}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_SECURE: "false"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app_net

  # RQ Dashboard (optional - disable in production)
  rq-dashboard:
    container_name: ${APP_NAME:-school-attendance}-rq-dashboard-${APP_ENV:-dev}
    image: eoranged/rq-dashboard
    environment:
      RQ_DASHBOARD_REDIS_URL: redis://${APP_NAME:-school-attendance}-redis-${APP_ENV:-dev}:6379/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app_net
    profiles:
      - dev
      - debug

volumes:
  postgres_data:
  minio_data:

networks:
  app_net:
    external: true
    name: ${DOCKER_NETWORK:-net-dev}
