// Sync queue
const Sync={isSyncing:false,async processQueue(){if(this.isSyncing||!State.isOnline())return;const queue=await IDB.getAll('queue');const pending=queue.filter(e=>e.status==='pending'||e.status==='error');if(!pending.length)return;this.isSyncing=true;UI.showToast('Sincronizando...','info',1000);for(const event of pending.slice(0,5)){event.status='in_progress';await IDB.put('queue',event);await this.simulateSync(event)}this.isSyncing=false},async simulateSync(event){return new Promise(resolve=>{setTimeout(async()=>{const success=Math.random()>.15;event.status=success?'synced':'error';if(!success)event.retries=(event.retries||0)+1;await IDB.put('queue',event);resolve(success)},500+Math.random()*1000)})},async syncNow(){if(!State.isOnline()){UI.showToast('Dispositivo offline','error');return}await this.processQueue();const queue=await IDB.getAll('queue');const synced=queue.filter(e=>e.status==='synced').length;const errors=queue.filter(e=>e.status==='error').length;UI.showToast(errors?`Sincronizado: ${synced}, Errores: ${errors}`:'SincronizaciÃ³n completa','success')}};setInterval(()=>State.isOnline()&&Sync.processQueue(),30000);
