Views.scanQR=async function(){if(!State.currentCourseId){Router.navigate('/classes');return}const app=document.getElementById('app');app.innerHTML=`${UI.createHeader('Escaneo QR')}<div class="container"><div class="card"><div class="card-header">Simular Escaneo QR</div><div class="form-group"><label class="form-label">Token QR</label><input type="text" id="qr-input" class="form-input" placeholder="qr_st_001"><button class="btn btn-secondary mt-2" onclick="Views.scanQR.generate()">Generar Válido</button></div><button class="btn btn-primary" onclick="Views.scanQR.scan()">Simular Lectura</button></div><div class="card"><div class="card-header">Tokens de Prueba</div><div style="font-size:.875rem">qr_st_001, qr_st_002, qr_st_011, qr_st_021</div></div><button class="btn btn-secondary" onclick="Router.navigate('/roster')">← Volver</button></div>`;Views.scanQR.generate=async function(){const students=await IDB.getAll('students');const random=students[Math.floor(Math.random()*students.length)];document.getElementById('qr-input').value=random.qr_token};Views.scanQR.scan=async function(){const token=document.getElementById('qr-input').value.trim();const students=await IDB.getAll('students');const student=students.find(s=>s.qr_token===token);if(!student){UI.showToast('Token no válido','error');return}const queue=await IDB.getAll('queue');const today=new Date().toISOString().split('T')[0];const hasIN=queue.some(e=>e.student_id===student.id&&e.type==='IN'&&e.ts.startsWith(today));const type=hasIN?'OUT':'IN';await State.enqueueEvent({student_id:student.id,type,course_id:State.currentCourseId,source:'QR',ts:new Date().toISOString()});UI.showToast(`${student.full_name} - ${type} registrado`,'success');setTimeout(()=>Router.navigate('/roster'),1500)}};
