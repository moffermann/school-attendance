// State management with IndexedDB
const State={currentTeacherId:null,currentCourseId:null,localSeq:0,deviceId:'',async init(){await IDB.open();const stored=localStorage.getItem('teacherSession');if(stored){const{teacherId,courseId,deviceId,localSeq}=JSON.parse(stored);this.currentTeacherId=teacherId;this.currentCourseId=courseId;this.deviceId=deviceId||'DEV-'+Math.random().toString(36).substr(2,6);this.localSeq=localSeq||0}const students=await IDB.getAll('students');if(!students.length){await this.loadFromJSON()}},async loadFromJSON(){const files=['teachers','courses','rosters','students','attendance_local','queue','config'];for(const file of files){try{const res=await fetch(`data/${file}.json`);const data=await res.json();await IDB.clear(file);if(Array.isArray(data)){for(const item of data)await IDB.put(file,item)}else{await IDB.put(file,{id:1,...data})}}catch(e){console.error(`Error loading ${file}`,e)}}},setSession(teacherId,courseId){this.currentTeacherId=teacherId;this.currentCourseId=courseId;if(!this.deviceId)this.deviceId='DEV-'+Math.random().toString(36).substr(2,6);localStorage.setItem('teacherSession',JSON.stringify({teacherId,courseId,deviceId:this.deviceId,localSeq:this.localSeq}))},logout(){this.currentTeacherId=null;this.currentCourseId=null;localStorage.removeItem('teacherSession')},async enqueueEvent(event){this.localSeq++;event.local_seq=this.localSeq;event.device_id=this.deviceId;event.status='pending';event.retries=0;event.id=Date.now()+Math.random();await IDB.put('queue',event);localStorage.setItem('teacherSession',JSON.stringify({teacherId:this.currentTeacherId,courseId:this.currentCourseId,deviceId:this.deviceId,localSeq:this.localSeq}));return event},isOnline(){const config=JSON.parse(localStorage.getItem('pwaConfig')||'{}');return config.online!==false},toggleOnline(){const config=JSON.parse(localStorage.getItem('pwaConfig')||'{}');config.online=!config.online;localStorage.setItem('pwaConfig',JSON.stringify(config))}};
