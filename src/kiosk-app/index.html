<!DOCTYPE html>
<html lang="es-CL">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Kiosco de Acceso</title>
  <!-- Google Fonts - Kiosk Redesign 2026 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <!-- Debug Console Overlay - tap top-right corner to toggle -->
  <div id="debug-console" style="
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    max-height: 40vh;
    background: rgba(0,0,0,0.9);
    color: #0f0;
    font-family: monospace;
    font-size: 11px;
    overflow-y: auto;
    z-index: 99999;
    padding: 8px;
    display: none;
    white-space: pre-wrap;
    word-break: break-all;
  "></div>
  <button id="debug-toggle" style="
    position: fixed;
    top: 5px;
    right: 5px;
    width: 40px;
    height: 40px;
    background: rgba(255,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    z-index: 100000;
    font-size: 16px;
    cursor: pointer;
  ">üêõ</button>
  <script>
    (function() {
      const debugEl = document.getElementById('debug-console');
      const toggleBtn = document.getElementById('debug-toggle');
      let visible = false;

      toggleBtn.addEventListener('click', () => {
        visible = !visible;
        debugEl.style.display = visible ? 'block' : 'none';
        toggleBtn.style.background = visible ? 'rgba(0,255,0,0.7)' : 'rgba(255,0,0,0.7)';
      });

      function addLog(type, args) {
        const time = new Date().toLocaleTimeString();
        const msg = Array.from(args).map(a =>
          typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)
        ).join(' ');
        const color = type === 'error' ? '#f00' : type === 'warn' ? '#ff0' : '#0f0';
        debugEl.innerHTML += `<div style="color:${color}">[${time}] ${type.toUpperCase()}: ${msg}</div>`;
        debugEl.scrollTop = debugEl.scrollHeight;
      }

      const origLog = console.log;
      const origError = console.error;
      const origWarn = console.warn;

      console.log = function() { origLog.apply(console, arguments); addLog('log', arguments); };
      console.error = function() { origError.apply(console, arguments); addLog('error', arguments); };
      console.warn = function() { origWarn.apply(console, arguments); addLog('warn', arguments); };
    })();
  </script>

  <a href="#app" class="skip-link">Saltar al contenido principal</a>
  <div id="toast-container" class="toast-container" aria-live="polite"></div>
  <main id="app" tabindex="-1">
    <div class="loading-screen">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>
  </main>

  <script src="js/state.js"></script>
  <script src="js/i18n.js"></script>
  <script src="js/sync.js"></script>
  <script src="js/webauthn.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/router.js"></script>

  <script src="js/views/home.js"></script>
  <script src="js/views/scan.js"></script>
  <script src="js/views/scan_result.js"></script>
  <script src="js/views/manual_entry.js"></script>
  <script src="js/views/queue.js"></script>
  <script src="js/views/device_status.js"></script>
  <script src="js/views/settings.js"></script>
  <script src="js/views/help.js"></script>
  <script src="js/views/admin_panel.js"></script>
  <script src="js/views/biometric_auth.js"></script>
  <script src="js/views/biometric_enroll.js"></script>

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(err => {
        console.error('SW registration failed', err);
      });
    }

    window.addEventListener('DOMContentLoaded', async () => {
      console.log('[INIT] DOMContentLoaded fired');

      try {
        console.log('[INIT] Calling State.init()...');
        await State.init();
        console.log('[INIT] State.init() complete, config:', State.config);

        I18n.init();
        console.log('[INIT] I18n.init() complete');

        // Sync with backend on startup if API key is configured (with timeout)
        if (State.config.deviceApiKey && State.config.deviceApiKey !== 'CONFIGURE_DEVICE_KEY_HERE') {
          console.log('[INIT] Starting syncBootstrap with 10s timeout...');
          const syncPromise = Sync.syncBootstrap();
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Sync timeout')), 10000)
          );

          try {
            await Promise.race([syncPromise, timeoutPromise]);
            console.log('[INIT] syncBootstrap complete');
          } catch (err) {
            console.warn('[INIT] syncBootstrap failed or timed out:', err.message);
          }

          // Start automatic heartbeat to keep device marked as online
          // and report battery level to backend
          Sync.startHeartbeat();
        }

        console.log('[INIT] Calling Router.init()...');
        Router.init();
        console.log('[INIT] Router.init() complete');
      } catch (err) {
        console.error('[INIT] Critical error during initialization:', err);
        // Still try to start the router even if init fails
        Router.init();
      }
    });
  </script>
</body>
</html>
